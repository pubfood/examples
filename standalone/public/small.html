<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Pubfood World Simulator</title>
        <style>body { font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; }</style>
    </head>
    <body>
        <script src="/pubfood.js"></script>
        <script>
          // global for the auction provider
          window.auctionProviderOne = window.auctionProviderOne || {};
          auctionProviderOne.cmd = auctionProviderOne.cmd || [];

          // globals for all bid providers
          window.bp1 = window.bp1 || {};
          bp1.cmd = bp1.cmd || [];
          window.bp2 = window.bp2 || {};
          bp2.cmd = bp2.cmd || [];
          window.bp3 = window.bp3 || {};
          bp3.cmd = bp3.cmd || [];

          // setup pubfood and hook it up to providers
          var food = new pubfood();
          food.addSlot({
            name: '/2476204/multi-size',
            sizes: [
              [300, 250],
              [300, 600]
            ],
            elementId: 'div-multi-size',
            bidProviders: {
              bp1: {
                slot: 'multi'
              },
              bp2: {
                slot: 'multi'
              },
              bp3: {
                slot: 'multi'
              }
            }
          });
          food.addSlot({
            name: '/2476204/rail',
            sizes: [
              [300, 250]
            ],
            elementId: 'div-rail',
            bidProviders: {
              bp1: {
                slot: 'rail'
              },
              bp2: {
                slot: 'rail'
              },
              bp3: {
                slot: 'rail'
              }
            }
          });
          food.addBidProvider({
            name: 'bp1',
            libUri: '/simulated-bid-provider/bp1.js',
            sync: true,
            init: function(slots, options, next, done) {
              bp1.cmd.push(function() {
                var encodedAvailability = encodeURIComponent('multi:300x250|300x600:400,rail:300x250:650');
                bp1.init('delay=200&fuzz=10&availability=' + encodedAvailability);
              });
              bp1.cmd.push(function() {
                var i;
                var slotMap = {};
                // TODO decide if slots are an array or an object
                for (key in slots) {
                  /** @todo: should not need to reference oneself here */
                  slotMap[slots[key].bidProviders.bp1.slot] = key;
                }
                var getSizes = function (raw) {
                  var i;
                  var sizeSplit;
                  var sizes = [];
                  var sizesRaw = raw.split('|');
                  for (i = 0; i < sizesRaw.length; i++) {
                    sizeSplit = sizesRaw[i].split('x');
                    sizes[i] = [parseInt(sizeSplit[0], 10), parseInt(sizeSplit[1], 10)];
                  }
                  return sizes;
                };
                var parts;
                var availableSlots = bp1.getAvailable().split(',');
                for (i = 0; i < availableSlots.length; i++) {
                  parts = availableSlots[i].split(':');
                  // TODO consider different bids for different sizes
                  next({
                    slot: slotMap[parts[0]],
                    value: parts[2],
                    sizes: getSizes(parts[1]),
                    targeting: {
                      bp1_bid: parts[2]
                    }
                  });
                }
                done();
              });
            },
            refresh: function(slots, options, done) {
            }
          });

          food.addBidProvider({
            name: 'bp2',
            libUri: '/simulated-bid-provider/bp2.js',
            sync: true,
            init: function(slots, options, next, done) {
              bp2.cmd.push(function() {
                var encodedAvailability = encodeURIComponent('multi:300x250|300x600:800,rail:300x250:950');
                bp2.init('delay=200&fuzz=10&availability=' + encodedAvailability);
              });
              bp2.cmd.push(function() {
                var i;
                var slotMap = {};
                // TODO decide if slots are an array or an object
                for (key in slots) {
                  /** @todo: should not need to reference oneself here */
                  slotMap[slots[key].bidProviders.bp2.slot] = key;
                }
                var getSizes = function (raw) {
                  var i;
                  var sizeSplit;
                  var sizes = [];
                  var sizesRaw = raw.split('|');
                  for (i = 0; i < sizesRaw.length; i++) {
                    sizeSplit = sizesRaw[i].split('x');
                    sizes[i] = [parseInt(sizeSplit[0], 10), parseInt(sizeSplit[1], 10)];
                  }
                  return sizes;
                };
                var parts;
                var availableSlots = bp2.getAvailable().split(',');
                for (i = 0; i < availableSlots.length; i++) {
                  parts = availableSlots[i].split(':');
                  // TODO consider different bids for different sizes
                  next({
                    slot: slotMap[parts[0]],
                    value: parts[2],
                    sizes: getSizes(parts[1]),
                    targeting: {
                      bp2_bid: parts[2]
                    }
                  });
                }
                done();
              });
            },
            refresh: function(slots, options, done) {
            }
          });

          food.addBidProvider({
            name: 'bp3',
            libUri: '/simulated-bid-provider/bp3.js',
            sync: true,
            init: function(slots, options, next, done) {
              bp3.cmd.push(function() {
                var encodedAvailability = encodeURIComponent('multi:300x250|300x600:900,rail:300x250:975');
                bp3.init('delay=200&fuzz=10&availability=' + encodedAvailability);
              });
              bp3.cmd.push(function() {
                var i;
                var slotMap = {};
                // TODO decide if slots are an array or an object
                for (key in slots) {
                  /** @todo: should not need to reference oneself here */
                  slotMap[slots[key].bidProviders.bp3.slot] = key;
                }
                var getSizes = function (raw) {
                  var i;
                  var sizeSplit;
                  var sizes = [];
                  var sizesRaw = raw.split('|');
                  for (i = 0; i < sizesRaw.length; i++) {
                    sizeSplit = sizesRaw[i].split('x');
                    sizes[i] = [parseInt(sizeSplit[0], 10), parseInt(sizeSplit[1], 10)];
                  }
                  return sizes;
                };
                var parts;
                var availableSlots = bp3.getAvailable().split(',');
                for (i = 0; i < availableSlots.length; i++) {
                  parts = availableSlots[i].split(':');
                  // TODO consider different bids for different sizes
                  next({
                    slot: slotMap[parts[0]],
                    value: parts[2],
                    sizes: getSizes(parts[1]),
                    targeting: {
                      bp3_bid: parts[2]
                    }
                  });
                }
                done();
              });
            },
            refresh: function(slots, options, done) {
            }
          });

          food.setAuctionProvider({
            name: 'auctionProviderOne',
            libUri: '/simulated-auction-provider/auctionProviderOne.js',
            init: function(targets, options, done) {
              auctionProviderOne.cmd.push(function() {
                var i, t;
                for (i = 0; i < targets.length; i++) {
                  var target = targets[i];

                  if(target.type === 'page'){
                    // set page level targeting
                    for(t in target.targeting){
                      auctionProviderOne.setTargeting(t, target.targeting[t]);
                    }
                  }

                  if(target.type === 'slot'){
                    var apSlot = auctionProviderOne.defineSlot(target.name, target.sizes, target.elementId);

                    // set slot level targeting
                    for(t in target.targeting){
                      apSlot.setTargeting(t, target.targeting[t]);
                    }

                  }
                }
              });

              auctionProviderOne.cmd.push(function() {
                auctionProviderOne
                  .enableSingleRequest()
                  .enableServices();
              });

              done();
            },
            refresh: function(slots, customTargeting, done) {
              done();
            }
          });

          food.timeout(1000)
          var timeReference = +new Date();
          food.addReporter(function(ev) {
            console.log(ev);
            console.log(ev.type, 'delay in ms:', ev.ts - timeReference);
          });
          food.start(timeReference);
        </script>
        <h1>Welcome Publisher People</h1>
        <p>We're here to help.</p>
        <p>Here are a couple of slots on a simulated page.</p>
        <p>Instead of an ad they show the pubfood information.</p>
        <p>All information shown is available to the auction.</p>
        <div style="position:relative;height:250px">
          <div style="position:absolute" id="div-multi-size"></div>
          <div style="position:absolute;left:310px" id="div-rail"></div>
        </div>
        <script>
          // TODO wrap in some pubfood api to delay this until after auction
          // until that wrapping happens the bids should stay sync
          auctionProviderOne.cmd.push(function() {
            auctionProviderOne.display('div-multi-size');
            auctionProviderOne.display('div-rail');
          });
        </script>
        <p>Please open up the devtools for more information in the console</p>
        <p>Feedback is warmly welcome be it questions, comments or concerns.</p>
        <p>Join us on slack to continue the conversation.</p>
        <p>We're all trying to make this the best we can.</p>
    </body>
</html>
